#!/usr/bin/env ruby
# frozen_string_literal: true

HELP = <<~HELP
  Usage: ros <command> [options]

  Commands:
     list                 list all available benchmarks
     run [<regexp>]       run all benchmarks
     compare [<regexp>]   compare benchmarks and present fastest code
     test [<regexp>]      test benchmarks validity
     help                 display this help
     version              display version information

  If an optional regular expression is given (<regexp>) then only benchmarks
  with matching name will be used for the command.
HELP

def load_all!
  require('bundler/inline')
  gemfile do
    source('https://rubygems.org')
    gem('benchmark-ips', '>=2.9.3')
  end
  require("#{ROOT_DIR}/lib/ruby-on-speed")
  Dir["#{ROOT_DIR}/benchmarks/**/*_bench.rb"].sort!.each { |fname| load(fname) }
  RubyOnSpeed.filter! ARGV.join(' ')
end

$stdout.sync = $stderr.sync = true
ROOT_DIR = File.realdirpath('..', __dir__)
case COMMAND = ARGV.shift
when nil, '-h', '--help', 'help'
  puts HELP
when '-v', '--version', 'version'
  require "#{ROOT_DIR}/lib/ruby-on-speed/version"
  puts "RubyOnSpeed v#{RubyOnSpeed::VERSION} for #{RUBY_DESCRIPTION.capitalize}"
when 'list'
  markdown = ARGV.delete('--markdown')
  load_all!
  benchmarks = RubyOnSpeed.to_a
  if markdown
    benchmarks.each do |bm|
      puts "- [#{bm.name}](#{bm.source_file_name}) - #{bm.description}"
    end
  else
    width = benchmarks.max_by { |bm| bm.name.size }.name.size
    benchmarks.each { |bm| puts "#{bm.name.ljust(width)}  #{bm.description}" }
  end
when 'run'
  compact = ARGV.delete('--compact')
  json = ARGV.delete('--json')
  load_all!
  exit RubyOnSpeed.report!(compact: true) if compact
  exit json ? RubyOnSpeed.json_report! : RubyOnSpeed.report!
when 'compare'
  load_all!
  exit RubyOnSpeed.find_best!
when 'test'
  load_all!
  exit RubyOnSpeed.test!
else
  $stderr.puts "ros: no such command - #{COMMAND}"
  exit 2
end
